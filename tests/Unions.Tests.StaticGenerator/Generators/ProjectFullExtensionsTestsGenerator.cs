using Toarnbeike.Unions.Utitilies;

namespace Toarnbeike.Unions.Generators;

/// <summary>
/// Generates tests for the Project full extension methods.
/// This code is build-time tooling; readability and determinism are preferred over abstraction.
/// </summary>
internal static class ProjectFullExtensionsTestsGenerator
{
    private static int[] _arities = null!;
    private static string _union = null!;

    public static string Generate(int arity)
    {
        _arities = [.. Enumerable.Range(1, arity)];
        _union = $"Union<{string.Join(',', _arities.Select(i => "U" + i))}>";

        return $$"""
                 {{AutoGeneratedMessageGenerator.GetAutoGeneratedMessage(nameof(ProjectFullExtensionsTestsGenerator))}}

                 using Toarnbeike.Unions.Extensions;
                 using Toarnbeike.Unions.TestExtensions;
                 using Toarnbeike.Unions.Tests.Unions.TestTypes;
                 // Resharper disable UnusedParameter.Local

                 namespace Toarnbeike.Unions.Tests.Extensions.Project.Generated;

                 public class Project{{arity:D2}}FullTests
                 {
                 {{string.Join("\n", _arities.Select(FactoryMethod))}}
                 {{HelperMethods()}}
                 {{string.Join("\n", _arities.Select(Project))}}
                 {{string.Join("\n", _arities.Select(ProjectAsync))}}
                 {{string.Join("\n", _arities.Select(TaskProject))}}
                 {{string.Join("\n", _arities.Select(TaskProjectAsync))}}
                 }
                 """;
    }

    private static string FactoryMethod(int arity)
    {
        return $"    private static {_union} MakeT{arity}(int v) => {_union}.FromT{arity}(new U{arity}(v));";
    }

    private static string HelperMethods()
    {
        return $"""

                    private static int? NullFunc(int original) => null;
                    private static Task<int?> NullAsyncFunc(int original) => Task.FromResult<int?>(null);
                    private static int ShouldNotBeCalled(int original) => throw new ShouldNotBeCalledException();
                    private static Task<int> ShouldNotBeCalledAsync(int original) => throw new ShouldNotBeCalledException();
                """;
    }

    private static string Project(int arity)
    {
        return $$"""

                     [Test]
                     public void Project_Should_InvokeT{{arity}}Projection()
                     {
                         var union = MakeT{{arity}}({{arity}});
                         var result = union.Project(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLine(i, i == arity)))}}
                         );
                         
                         result.ShouldBeT{{arity}}({{arity + 10}});
                     }
                     
                     [Test]
                     public void Project_Throws_WhenT{{arity}}_Projection_ReturnsNull()
                     {
                         var union = MakeT{{arity}}({{arity}});
                         
                         Should.Throw<ArgumentNullException>(() => union.Project(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLineNull(i, i == arity)))}}
                         ));
                     }   
                 """;
    }

    private static string ProjectAsync(int arity)
    {
        return $$"""

                     [Test]
                     public async Task ProjectAsync_Should_InvokeT{{arity}}Projection()
                     {
                         var union = MakeT{{arity}}({{arity}});
                         var result = await union.ProjectAsync(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLineAsync(i, i == arity)))}}
                         );
                         
                         result.ShouldBeT{{arity}}({{arity + 10}});
                     }
                     
                     [Test]
                     public async Task ProjectAsync_Throws_WhenT{{arity}}_Projection_ReturnsNull()
                     {
                         var union = MakeT{{arity}}({{arity}});
                         
                         await Should.ThrowAsync<ArgumentNullException>(() => union.ProjectAsync(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLineNullAsync(i, i == arity)))}}
                         ));
                     }   
                 """;
    }

    private static string TaskProject(int arity)
    {
        return $$"""

                     [Test]
                     public async Task TaskProject_Should_InvokeT{{arity}}Projection()
                     {
                         var task = Task.FromResult(MakeT{{arity}}({{arity}}));
                         
                         var result = await task.Project(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLine(i, i == arity)))}}
                         );
                         
                         result.ShouldBeT{{arity}}({{arity + 10}});
                     }
                 """;
    }

    private static string TaskProjectAsync(int arity)
    {
        return $$"""

                     [Test]
                     public async Task TaskProjectAsync_Should_InvokeT{{arity}}Projection()
                     {
                         var task = Task.FromResult(MakeT{{arity}}({{arity}}));

                         var result = await task.ProjectAsync(
                             {{string.Join(",\n            ", _arities.Select(i => ProjectLineAsync(i, i == arity)))}}
                         );
                         
                         result.ShouldBeT{{arity}}({{arity + 10}});
                     }
                 """;
    }

    private static string ProjectLine(int arity, bool isTarget)
    {
        return isTarget
            ? $"u{arity} => u{arity}.Value + 10"
            : $"u{arity} => ShouldNotBeCalled(u{arity}.Value)";
    }

    private static string ProjectLineAsync(int arity, bool isTarget)
    {
        return isTarget
            ? $"u{arity} => Task.FromResult(u{arity}.Value + 10)"
            : $"u{arity} => ShouldNotBeCalledAsync(u{arity}.Value)";
    }

    private static string ProjectLineNull(int arity, bool isTarget)
    {
        return isTarget
            ? $"u{arity} => NullFunc(u{arity}.Value)"
            : $"u{arity} => ShouldNotBeCalled(u{arity}.Value)";
    }

    private static string ProjectLineNullAsync(int arity, bool isTarget)
    {
        return isTarget
            ? $"u{arity} => NullAsyncFunc(u{arity}.Value)"
            : $"u{arity} => ShouldNotBeCalledAsync(u{arity}.Value)";
    }
}