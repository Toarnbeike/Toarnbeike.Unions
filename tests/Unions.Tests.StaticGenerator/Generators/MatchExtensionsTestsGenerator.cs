using Toarnbeike.Unions.Utitilies;

namespace Toarnbeike.Unions.Generators;

/// <summary>
/// Generates tests for the Match extension methods.
/// This code is build-time tooling; readability and determinism are preferred over abstraction.
/// </summary>
internal static class MatchExtensionsTestsGenerator
{

    private static Context _context = null!;

    public static string Generate(int arity)
    {
        var arities = Enumerable.Range(1, arity).ToArray();
        _context = new Context(
            Arities: arities,
            Union: $"Union<{string.Join(',', arities.Select(i => "U" + i))}>"
        );

        return $$"""
            {{AutoGeneratedMessageGenerator.GetAutoGeneratedMessage(nameof(MatchExtensionsTestsGenerator))}}
            
            using Toarnbeike.Unions.Extensions;
            using Toarnbeike.Unions.Tests.Unions.TestTypes;

            namespace Toarnbeike.Unions.Tests.Extensions.Match.Generated;

            public class Match{{arity:D2}}ExtensionTests
            {
            {{string.Join("\n", arities.Select(FactoryMethod))}}
            {{string.Join("\n", arities.Select(MatchTest))}}
            {{string.Join("\n", arities.Select(MatchNullTest))}}
            {{MatchInvalidIndex()}}
            {{string.Join("\n", arities.Select(MatchAsyncTest))}}
            {{string.Join("\n", arities.Select(MatchNullAsyncTest))}}
            {{MatchInvalidIndexAsync()}}
            {{string.Join("\n", arities.Select(TaskMatchTest))}}
            {{string.Join("\n", arities.Select(TaskMatchAsyncTest))}}
            }
            """;
    }

    private static string FactoryMethod(int arity)
    {
        return $"    private static {_context.Union} MakeT{arity}(int v) => {_context.Union}.FromT{arity}(new U{arity}(v));";
    }

    private static string MatchTest(int arity)
    {
        return $$"""

                [Test]
                public void Match_Should_Invoke_T{{arity}}_Handler()
                {
                    var union = MakeT{{arity}}({{arity}});
                    var result = union.Match(
            {{string.Join(",\n", _context.Arities.Select(MatchLine))}}
                    );

                    result.ShouldBe("T{{arity}}:{{arity}}");
                }
            """;
    }

    private static string MatchAsyncTest(int arity)
    {
        return $$"""

                [Test]
                public async Task MatchAsync_Should_Invoke_T{{arity}}_Handler()
                {
                    var union = MakeT{{arity}}({{arity}});
                    var result = await union.MatchAsync(
            {{string.Join(",\n", _context.Arities.Select(MatchAsyncLine))}}
                    );

                    result.ShouldBe("T{{arity}}:{{arity}}");
                }
            """;
    }

    private static string TaskMatchTest(int arity)
    {
        return $$"""

                [Test]
                public async Task TaskMatch_Should_Invoke_T{{arity}}_Handler()
                {
                    var task = Task.FromResult(MakeT{{arity}}({{arity}}));

                    var result = await task.Match(
            {{string.Join(",\n", _context.Arities.Select(MatchLine))}}
                    );
            
                    result.ShouldBe("T{{arity}}:{{arity}}");
                }
            """;
    }

    private static string TaskMatchAsyncTest(int arity)
    {
        return $$"""

                [Test]
                public async Task TaskMatchAsync_Should_Invoke_T{{arity}}_Handler()
                {
                    var task = Task.FromResult(MakeT{{arity}}({{arity}}));

                    var result = await task.MatchAsync(
            {{string.Join(",\n", _context.Arities.Select(MatchAsyncLine))}}
                    );

                    result.ShouldBe("T{{arity}}:{{arity}}");
                }
            """;
    }

    private static string MatchLine(int arity)
    {
        return $$"""
                        t{{arity}} => $"T{{arity}}:{t{{arity}}.Value}"
            """;
    }

    private static string MatchAsyncLine(int arity)
    {
        return $$"""
                        async t{{arity}} => { await Task.Yield(); return $"T{{arity}}:{t{{arity}}.Value}"; }
            """;
    }

    private static string MatchNullTest(int arity)
    {
        return $$"""

                [Test]
                public void Match_Should_Throw_On_Null_T{{arity}}_Handler()
                {
                    var union = MakeT{{arity}}({{arity}});
                    Should.Throw<ArgumentNullException>(() => union.Match({{NullArguments(arity)}}));
                }
            """;
    }

    private static string MatchNullAsyncTest(int arity)
    {
        return $$"""

                [Test]
                public async Task MatchAsync_Should_Throw_On_Null_T{{arity}}_Handler()
                {
                    var union = MakeT{{arity}}({{arity}});
                    await Should.ThrowAsync<ArgumentNullException>(async () => await union.Match({{NullAsyncArguments(arity)}}));
                }
            """;
    }

    private static string MatchInvalidIndex()
    {
        return $$"""

                [Test]
                public void Match_Should_Throw_On_Invalid_Index()
                {
                    var invalid = new {{_context.Union}}();

                    var ex = Should.Throw<InvalidOperationException>(() => invalid.Match({{ValidArguments()}}));
                    ex.Message.ShouldBe("Union index 0 is invalid.");
                }
            """;
    }

    private static string MatchInvalidIndexAsync()
    {
        return $$"""

                [Test]
                public async Task MatchAsync_Should_Throw_On_Invalid_Index()
                {
                    var invalid = new {{_context.Union}}();

                    var ex = await Should.ThrowAsync<InvalidOperationException>(async () => await invalid.MatchAsync({{ValidAsyncArguments()}}));
                    ex.Message.ShouldBe("Union index 0 is invalid.");
                }
            """;
    }

    private static string NullArguments(int arity)
    {
        return string.Join(", ", _context.Arities.Select(i => i == arity ? "null!" : $"_ => {i}"));
    }

    private static string NullAsyncArguments(int arity)
    {
        return string.Join(", ", _context.Arities.Select(i => i == arity ? "null!" : $"_ => Task.FromResult({i})"));
    }

    private static string ValidArguments()
    {
        return string.Join(",", _context.Arities.Select(i => $"_ => {i}"));
    }

    private static string ValidAsyncArguments()
    {
        return string.Join(", ", _context.Arities.Select(i => $"_ => Task.FromResult({i})"));
    }

    private sealed record Context(int[] Arities, string Union);
}

