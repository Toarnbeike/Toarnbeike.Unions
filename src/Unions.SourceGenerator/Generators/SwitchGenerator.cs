using Microsoft.CodeAnalysis;

namespace Toarnbeike.Unions.Generators;

using Toarnbeike.Unions.Model;
 
internal static class SwitchGenerator
{
    public static string Execute(UnionModel model)
    {
        var parameters = string.Join(", ",
            model.Cases.Select(c => $"Action<{c.TypeName}> {c.ArgumentName}"));

        var parametersAsync = string.Join(", ",
            model.Cases.Select(c => $"Func<{c.TypeName}, Task> {c.ArgumentName}"));

        var arguments = string.Join(", ", model.Cases.Select(c => c.ArgumentName));

        var xmlParameters = string.Join("\n        ", model.Cases.Select(c =>
            $"/// <param name=\"{c.ArgumentName}\">The action to invoke when the union holds a {c.Name} value.</param>"));


        return $$"""
            # nullable enable
            
            // <auto-generated>
            //   This file was generated by Toarnbeike.Unions.SourceGenerator.
            //   Generator: {{nameof(SwitchGenerator)}}
            //   Created: {{DateTime.UtcNow:u}}
            //   This is an auto-generated file. Do not modify.
            // </auto-generated>
            
            using Toarnbeike.Unions;
            using Toarnbeike.Unions.Extensions;
            {{model.CaseUsings}}

            namespace {{model.Namespace}};

            /// <summary>
            /// Switch: extension methods to perform an action on union values.
            /// </summary>
            public static class {{model.Name}}SwitchExtensions
            {
                extension({{model.Name}} {{model.ArgumentName}})
                {
                    /// <summary>
                    /// Switch on the value stored in the union and invokes the corresponding side effect based on its type.
                    /// </summary>
                    {{xmlParameters}}
                    /// <exception cref="InvalidOperationException">Thrown if the union is not in a valid state.</exception>
                    public void Switch({{parameters}})
                        => {{model.ArgumentName}}.AsUnion().Switch({{arguments}});
            
                    /// <summary>
                    /// Switch on the value stored in the union and invokes the corresponding async side effect based on its type.
                    /// </summary>
                    {{xmlParameters}}
                    /// <exception cref="InvalidOperationException">Thrown if the union is not in a valid state.</exception>
                    public Task SwitchAsync({{parametersAsync}})
                        => {{model.ArgumentName}}.AsUnion().SwitchAsync({{arguments}});
                }
                extension(Task<{{model.Name}}> {{model.ArgumentName}}Task)
                {
                    /// <summary>
                    /// Switch on the value stored in the union and invokes the corresponding side effect based on its type.
                    /// </summary>
                    {{xmlParameters}}
                    /// <exception cref="InvalidOperationException">Thrown if the union is not in a valid state.</exception>
                    public async Task Switch({{parameters}})
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task.ConfigureAwait(false);
                        {{model.ArgumentName}}.Switch({{arguments}});
                    }

                    /// <summary>
                    /// Switch on the value stored in the union and invokes the corresponding async side effect based on its type.
                    /// </summary>
                    {{xmlParameters}}
                    /// <exception cref="InvalidOperationException">Thrown if the union is not in a valid state.</exception>
                    public async Task SwitchAsync({{parametersAsync}})
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task.ConfigureAwait(false);
                        await {{model.ArgumentName}}.SwitchAsync({{arguments}}).ConfigureAwait(false);
                    }
                }
            }
            """;
    }
}
