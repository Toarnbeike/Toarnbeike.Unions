using Toarnbeike.Unions.SourceGenerator.Model;

#pragma warning disable CS0162 // Unreachable code detected - Binding of all branches at once is for now disabled, could later be fixed and reinstated.
// ReSharper disable HeuristicUnreachableCode

namespace Toarnbeike.Unions.SourceGenerator.Generators;

internal static class BindGenerator
{
    // todo: Reintroduce the binding of all branches simultaneously. 
    public static string Execute(UnionModel model)
    {
        return $$"""
            # nullable enable
            
            // <auto-generated>
            //   This file was generated by Toarnbeike.Unions.SourceGenerator.
            //   Generator: {{nameof(BindGenerator)}}
            //   Created: {{DateTime.UtcNow:u}}
            //   This is an auto-generated file. Do not modify.
            // </auto-generated>
            
            using Toarnbeike.Unions.Generic;
            using Toarnbeike.Unions.Generic.Extensions;
            {{model.CaseUsings}}
            
            namespace {{model.Namespace}};

            /// <summary>
            /// Bind: extension methods to bind (flatmap) union values.
            /// This gives the ability to transform a union case into another union case.
            /// </summary>
            public static class {{model.Name}}BindExtensions
            {
                extension({{model.Name}} {{model.ArgumentName}})
                {
            {{GenerateBindExtension(model)}}
            {{string.Join("\n", model.Cases.Select(unionCase => GenerateBindTExtension(model, unionCase)))}}
            {{GenerateBindAsyncExtension(model)}}
            {{string.Join("\n", model.Cases.Select(unionCase => GenerateBindTAsyncExtension(model, unionCase)))}}
                }
                extension(Task<{{model.Name}}> {{model.ArgumentName}}Task)
                {
            {{GenerateTaskBindExtension(model)}}
            {{string.Join("\n", model.Cases.Select(unionCase => GenerateTaskBindTExtension(model, unionCase)))}}
            {{GenerateTaskBindAsyncExtension(model)}}
            {{string.Join("\n", model.Cases.Select(unionCase => GenerateTaskBindTAsyncExtension(model, unionCase)))}}
                }
            }
            """;
    }

    private static string GenerateBindExtension(UnionModel model)
    {
        return string.Empty;
        var parameters = string.Join(", ", model.Cases.Select(c =>
            $"Func<{c.TypeName}, {model.Name}> bind{c.Name}"));

        var xmlParameters = string.Join("\n        ", model.Cases.Select(c =>
            $"/// <param name=\"bind{c.Name}\">The binding function if the union is in the {c.Name} value state. </param>"));

        var arguments = string.Join(", ", model.Cases.Select(c => $"bind{c.Name}"));

        return $"""
                    /// <summary>
                    /// Apply mapping functions to the value stored in the union based on its current state.
                    /// </summary>
                    {xmlParameters}
                    public {model.Name} Bind({parameters}) =>
                        {model.Name}.FromUnion({model.ArgumentName}.AsUnion().Bind({arguments}));

            """;

    }

    private static string GenerateBindTExtension(UnionModel model, UnionCaseModel caseModel)
    {
        return $"""
                    /// <summary>
                    /// Apply a binding to the value stored in the union if it is in the {caseModel.Name} state.
                    /// </summary>
                    /// <param name="bind">The mapping function to apply.</param>
                    public {model.Name} Bind{caseModel.Name}(Func<{caseModel.TypeName}, {model.Name}> bind) =>
                        {model.Name}.FromUnion({model.ArgumentName}.AsUnion().Bind{caseModel.BackingTypeName}(value => bind(value).AsUnion()));

            """;
    }

    private static string GenerateBindAsyncExtension(UnionModel model)
    {
        return string.Empty;
        var parameters = string.Join(", ", model.Cases.Select(c =>
            $"Func<{c.TypeName}, Task<{c.TypeName}>> map{c.Name}Async"));

        var xmlParameters = string.Join("\n        ", model.Cases.Select(c =>
            $"/// <param name=\"map{c.Name}Async\">The async mapping function if the union is in the {c.Name} value state. </param>"));

        var arguments = string.Join(", ", model.Cases.Select(c => $"map{c.Name}Async"));

        return $"""
                    /// <summary>
                    /// Apply async mapping functions to the value stored in the union bases on its current state.
                    /// </summary>
                    {xmlParameters}
                    public async Task<{model.Name}> BindAsync({parameters}) =>
                        await {model.Name}.FromUnionAsync({model.ArgumentName}.AsUnion().BindAsync({arguments}));

            """;
    }

    private static string GenerateBindTAsyncExtension(UnionModel model, UnionCaseModel caseModel)
    {
        return $"""
                    /// <summary>
                    /// Apply an async binding to the value stored in the union if it is in the {caseModel.Name} state.
                    /// </summary>
                    /// <param name="bindAsync">The async binding function to apply.</param>
                    public async Task<{model.Name}> Bind{caseModel.Name}Async(Func<{caseModel.TypeName}, Task<{model.Name}>> bindAsync) =>
                        await {model.Name}.FromUnionAsync({model.ArgumentName}.AsUnion().Bind{caseModel.BackingTypeName}Async(async value => (await bindAsync(value)).AsUnion()));
            
            """;
    }

    private static string GenerateTaskBindExtension(UnionModel model)
    {
        return string.Empty;
        var parameters = string.Join(", ", model.Cases.Select(c =>
            $"Func<{c.TypeName}, {c.TypeName}> map{c.Name}"));

        var xmlParameters = string.Join("\n        ", model.Cases.Select(c =>
            $"/// <param name=\"map{c.Name}\">The mapping function if the union is in the {c.Name} value state. </param>"));

        var arguments = string.Join(", ", model.Cases.Select(c => $"map{c.Name}"));

        return $$"""
                    /// <summary>
                    /// Apply mapping functions to the value stored in the union Task based on its current state.
                    /// </summary>
                    {{xmlParameters}}
                    public async Task<{{model.Name}}> Bind({{parameters}})
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task;
                        return {{model.ArgumentName}}.Bind({{arguments}});
                    }

            """;

    }

    private static string GenerateTaskBindTExtension(UnionModel model, UnionCaseModel caseModel)
    {
        return $$"""
                    /// <summary>
                    /// Apply a binding function to the value stored in the union Task if it is in the {{caseModel.Name}} state.
                    /// </summary>
                    /// <param name="bind">The binding function to apply.</param>
                    public async Task<{{model.Name}}> Bind{{caseModel.Name}}(Func<{{caseModel.TypeName}}, {{model.Name}}> bind)
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task;
                        return {{model.ArgumentName}}.Bind{{caseModel.Name}}(bind);
                    }

            """;
    }

    private static string GenerateTaskBindAsyncExtension(UnionModel model)
    {
        return string.Empty;
        var parameters = string.Join(", ", model.Cases.Select(c =>
            $"Func<{c.TypeName}, Task<{c.TypeName}>> map{c.Name}Async"));

        var xmlParameters = string.Join("\n        ", model.Cases.Select(c =>
            $"/// <param name=\"map{c.Name}Async\">The async mapping function if the union is in the {c.Name} value state. </param>"));

        var arguments = string.Join(", ", model.Cases.Select(c => $"map{c.Name}Async"));

        return $$"""
                    /// <summary>
                    /// Apply async mapping functions to the value stored in the union Task bases on its current state.
                    /// </summary>
                    {{xmlParameters}}
                    public async Task<{{model.Name}}> BindAsync({{parameters}})
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task;
                        return await {{model.ArgumentName}}.BindAsync({{arguments}});
                    }

            """;
    }

    private static string GenerateTaskBindTAsyncExtension(UnionModel model, UnionCaseModel caseModel)
    {
        return $$"""
                    /// <summary>
                    /// Apply an async binding function to the value stored in the union Task if it is in the {{caseModel.Name}} state.
                    /// </summary>
                    /// <param name="bindAsync">The async binding function to apply.</param>
                    public async Task<{{model.Name}}> Bind{{caseModel.Name}}Async(Func<{{caseModel.TypeName}}, Task<{{model.Name}}>> bindAsync)
                    {
                        var {{model.ArgumentName}} = await {{model.ArgumentName}}Task;
                        return await {{model.ArgumentName}}.Bind{{caseModel.Name}}Async(bindAsync);
                    }
            
            """;
    }
}
