using Toarnbeike.Unions.SourceGenerator.Model;

namespace Toarnbeike.Unions.SourceGenerator.Generators;

internal static class TestExtensionsGenerator
{
    public static string Execute(UnionModel model)
    {
        return $$"""
            # nullable enable
            
            // <auto-generated>
            //   This file was generated by Toarnbeike.Unions.SourceGenerator.
            //   Generator: {{nameof(TestExtensionsGenerator)}}
            //   Created: {{DateTime.UtcNow:u}}
            //   This is an auto-generated file. Do not modify.
            // </auto-generated>
            
            using Toarnbeike.Unions.Generic;
            using Toarnbeike.Unions.Generic.Extensions;
            using Toarnbeike.Unions.Generic.TestExtensions;
            using {{model.Namespace}};
            {{model.CaseUsings}}

            namespace Toarnbeike.Unions.Nominal.TestExtensions;

            public static class {{model.Name}}TestExtensions
            {
                extension({{model.Name}} {{model.ArgumentName}})
                {{{string.Join("\n         ", model.Cases.Select(caseModel => ShouldBe(caseModel, model.ArgumentName)))}}
                }
            }
            """;
    }

    private static string ShouldBe(UnionCaseModel caseModel, string unionName)
    {
        return $$"""

                    /// <summary>
                    /// Verifies that the union is in the {{caseModel.Name}} state.
                    /// </summary>
                    /// <returns>The value of the union, as {{caseModel.TypeName}}, if the union is in the {{caseModel.Name}} state.</returns>
                    /// <exception cref="AssertionFailedException">Thrown if the union is not in the {{caseModel.TypeName}} state.</exception>
                    public {{caseModel.TypeName}} ShouldBe{{caseModel.Name}}()
                    {                    
                        return {{unionName}}.TryGet{{caseModel.Name}}(out var value) 
                            ? value
                            : throw new AssertionFailedException($"Expected union to be {{caseModel.TypeName}}, but it was not.");
                    }

                    /// <summary>
                    /// Verifies that the union is in the {{caseModel.Name}} state and has the expected value.
                    /// </summary>
                    /// <param name="expected">The expected value of the union.</param>
                    /// <returns>The value of the union, as {{caseModel.TypeName}}, if the union is in the {{caseModel.Name}} state.</returns>
                    /// <exception cref="AssertionFailedException">Thrown if the union is not in the {{caseModel.TypeName}} state.</exception>
                    public {{caseModel.TypeName}} ShouldBe{{caseModel.Name}}({{caseModel.TypeName}} expected)
                    {
                        var actual = {{unionName}}.ShouldBe{{caseModel.Name}}();
                        if (!EqualityComparer<{{caseModel.TypeName}}>.Default.Equals(actual, expected))
                        {
                            throw new AssertionFailedException($"Expected {{caseModel.TypeName}} value to be {expected}, but it was {actual}.");
                        }
                        return actual;
                    }
            """;
    }
}
