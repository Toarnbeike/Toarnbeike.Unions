using System.Xml.Linq;

namespace Toarnbeike.Unions.Utilities;

internal static class AutoGeneratedMessageGenerator
{
    private static string _version = null!;

    public static string GetAutoGeneratedMessage(string generatorName)
    {
        _version ??= GetVersion();

        return $$"""
            # nullable enable

            // <auto-generated>
            //   This file was generated by Toarnbeike.Unions.StaticGenerator.
            //   Generator: {{generatorName}} (v. {{_version}})
            //   Created: {{DateTime.UtcNow:u}}
            //   This is an auto-generated file. Do not modify.
            // </auto-generated>
            """;
    }

    private static string GetVersion()
    {
        // Load Directory.Build.props and find the <Version> element
        var props = GetDirectoryBuildProps();
        var xml = XDocument.Load(props);

        // Get the default namespace of the file
        XNamespace ns = xml.Root?.Name.Namespace ?? XNamespace.None;

        var versionElement = xml
            .Descendants(ns + "Version")
            .FirstOrDefault();

        return versionElement?.Value
            ?? throw new InvalidOperationException("Version not found in Directory.Build.props");
    }

    private static string GetDirectoryBuildProps()
    {
        // Start from the current directory and move up to find Directory.Build.props
        var dir = new DirectoryInfo(Directory.GetCurrentDirectory());

        while (dir != null)
        {
            var props = Path.Combine(dir.FullName, "Directory.Build.props");
            if (File.Exists(props))
                return props;

            dir = dir.Parent;
        }

        throw new FileNotFoundException("Directory.Build.props not found.");
    }
}
