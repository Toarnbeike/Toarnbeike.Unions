using Toarnbeike.Unions.Utilities;

namespace Toarnbeike.Unions.Generators;

/// <summary>
/// Generates the union.Bind extension methods for the requested arities.
/// This code is build-time tooling; readability and determinism are preferred over abstraction.
/// </summary>
/// <remarks> The BindTExtensions are generated in <see cref="BindPartialExtensionsGenerator"/></remarks>
internal static class BindFullExtensionsGenerator
{
    public static string Generate(IEnumerable<int> arities)
    {
        return $$"""
            {{AutoGeneratedMessageGenerator.GetAutoGeneratedMessage(nameof(BindFullExtensionsGenerator))}}
            
            namespace Toarnbeike.Unions.Generic.Extensions;

            /// <summary>
            /// Bind: extension methods to bind (flatmap) union values.
            /// This gives the ability to transform a union case into another union case.
            /// </summary>
            /// <remarks> 
            /// This file deals with full binds, binding all possible cases of the union at once.
            /// For partial transforming, see the other part of this partial class.
            /// </remarks>
            public static partial class BindExtensions
            {{{string.Join("\n", arities.Select(GenerateBind))}}
            }
            """;
    }

    private static string GenerateBind(int arity)
    {
        var arities = Enumerable.Range(1, arity).ToArray();
        var genericArgs = $"<{string.Join(", ", arities.Select(i => $"T{i}"))}>";
        return $$"""

                     #region Bind Extensions for Union{{genericArgs}}

                     extension{{genericArgs}}(Union{{genericArgs}} union)
                     {
                 {{Bind(genericArgs, arities)}}
                 {{BindAsync(genericArgs, arities)}}
                     }
                     
                     extension{{genericArgs}}(Task<Union{{genericArgs}}> unionTask)
                     {
                 {{TaskBind(genericArgs, arities)}}
                 {{TaskBindAsync(genericArgs, arities)}}
                     }

                     #endregion
                 """;
    }

    private static string Bind(string genericArgs, int[] arities)
    {
        return $$"""

                         /// <summary>
                         /// Apply a binding function to the value stored in the union based on its current state.
                         /// </summary>
                         {{string.Join("\n        ", arities.Select(i => $"/// <param name=\"bindT{i}\">The binding function to apply if the union is in the T{i} state.</param>"))}}
                         public Union{{genericArgs}} Bind({{string.Join(", ", arities.Select(i => $"Func<T{i}, Union{genericArgs}> bindT{i}"))}})
                         {
                             {{string.Join("\n            ", arities.Select(i => $"ArgumentNullException.ThrowIfNull(bindT{i});"))}}

                             return union.Match({{string.Join(", ", arities.Select(i => $"bindT{i}"))}});
                         }
                 """;
    }

    private static string BindAsync(string genericArgs, int[] arities)
    {
        return $$"""

                         /// <summary>
                         /// Apply an async binding function to the value stored in the union based on its current state.
                         /// </summary>
                         {{string.Join("\n        ", arities.Select(i => $"/// <param name=\"bindT{i}Async\">The binding task to apply if the union is in the T{i} state.</param>"))}}
                         public Task<Union{{genericArgs}}> BindAsync({{string.Join(", ", arities.Select(i => $"Func<T{i}, Task<Union{genericArgs}>> bindT{i}Async"))}})
                         {
                             {{string.Join("\n            ", arities.Select(i => $"ArgumentNullException.ThrowIfNull(bindT{i}Async);"))}}

                             return union.MatchAsync({{string.Join(", ", arities.Select(i => $"bindT{i}Async"))}});
                         }
                 """;
    }

    private static string TaskBind(string genericArgs, int[] arities)
    {
        return $$"""

                         /// <summary>
                         /// Apply a binding function to the value stored in the task union based on its current state.
                         /// </summary>
                         {{string.Join("\n        ", arities.Select(i => $"/// <param name=\"bindT{i}\">The binding function to apply if the union is in the T{i} state.</param>"))}}
                         public async Task<Union{{genericArgs}}> Bind({{string.Join(", ", arities.Select(i => $"Func<T{i}, Union{genericArgs}> bindT{i}"))}})
                         {
                             var union = await unionTask.ConfigureAwait(false);
                             return union.Bind({{string.Join(", ", arities.Select(i => $"bindT{i}"))}});
                         }
                 """;
    }

    private static string TaskBindAsync(string genericArgs, int[] arities)
    {
        return $$"""

                         /// <summary>
                         /// Apply an async binding function to the value stored in the task union based on its current state.
                         /// </summary>
                         {{string.Join("\n        ", arities.Select(i => $"/// <param name=\"bindT{i}Async\">The binding task to apply if the union is in the T{i} state.</param>"))}}
                         public async Task<Union{{genericArgs}}> BindAsync({{string.Join(", ", arities.Select(i => $"Func<T{i}, Task<Union{genericArgs}>> bindT{i}Async"))}})
                         {
                             var union = await unionTask.ConfigureAwait(false);
                             return await union.BindAsync({{string.Join(", ", arities.Select(i => $"bindT{i}Async"))}}).ConfigureAwait(false);
                         }
                 """;
    }
}